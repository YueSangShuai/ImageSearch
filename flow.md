### 多属性行人图像检索系统流程（含特征建库与时空元信息过滤）

#### 0. 行人特征建库（系统前置条件）

- 对大规模原始图像集合，首先采用行人检测算法（如 YOLO、RetinaNet、DINO 等）检测行人目标。
- 对每个检测到的行人区域，利用特征向量化算法 $ \mathcal{A}_0 $ 提取嵌入向量特征：
  $$
  \mathbf{d}_i = \mathcal{A}_0(I_i)
  $$
  其中 $ I_i $ 为第 $ i $ 个行人图像或裁剪区域。
- 将所有行人特征向量 $ \{\mathbf{d}_1, \mathbf{d}_2, \ldots, \mathbf{d}_n\} $ 存入向量数据库，并关联存储原始图像、检测框、时间戳 $ t_i $、地点/摄像头 ID $ l_i $ 等元信息。

---

#### 1. 查询向量化

用户输入自然语言查询 $ T $，系统采用跨模态编码器（类似 CLIP 文本编码器）对查询进行特征抽取，生成文本嵌入向量：
$$
\mathbf{v} = \mathcal{A}_1(T)
$$

---

#### 2. 属性与时空信息解析

利用NLP类算法，如命名实体识别（NER）和属性抽取模块，对查询 $ T $ 解析并结构化出多维属性约束和时空约束，包括但不限于：
- 性别 $ g_T $、年龄 $ a_T $、上衣颜色 $ c_T $、上衣款式 $ s_T $、头发颜色 $ hc_T $、头发款式 $ hs_T $
- 时间约束 $ t_T $（如“昨天上午”、“2024年5月1日14:00”）
- 地点约束 $ l_T $（如“东门摄像头”、“A区”）

$$
(g_T, a_T, c_T, s_T, hc_T, hs_T, t_T, l_T， ...) = \mathrm{NER}(T)
$$

---

#### 3. 时空元信息过滤

在向量检索前，先根据解析得到的时间 $ t_T $ 和地点 $ l_T $，对数据库中的元信息进行过滤，仅保留满足时空约束的候选集：
$$
\mathcal{D}' = \left\{ \mathbf{d}_i \mid (t_T = \emptyset \vee t_i \in t_T) \wedge (l_T = \emptyset \vee l_i \in l_T) \right\}
$$

---

#### 4. 向量检索与初筛

针对过滤后的特征库 $ \mathcal{D}' $，计算每个图像特征与查询向量的相似度（如余弦相似度），并基于 Top-K 检索策略召回冗余候选集 $ \mathcal{P}' $：
$$
\mathcal{P}' = \mathrm{Top}_{m'}\left(\left\{ (\mathbf{d}_i, \mathrm{sim}(\mathbf{d}_i, \mathbf{v})) \mid \mathbf{d}_i \in \mathcal{D}' \right\}\right)
$$
其中 $ m' $ 通常为目标返回数量的若干倍，以保证后续属性过滤的召回率。

---

#### 5. 多属性后处理过滤

对候选集 $ \mathcal{P}' $ 中每个样本 $ \mathbf{p}_j $，依次应用各属性判别模型（如性别分类器、年龄估计器、服饰/发型属性识别模型）：
- 若属性约束 $ x_T $ 非空，则仅保留满足 $ x_j $ 接近 $ x_T $ 的样本，其中 $ x \in \{g, a, c, s, hc, hs, ... \} $。
- 属性判别模型分别记为 $ \mathcal{A}_2, \mathcal{A}_3, \ldots, \mathcal{A}_7 $，本系统第一版采用基于图像向量输入的轻量级分类器：
  $$
  x_j = \mathcal{A}_k(\mathbf{p}_j), \quad x \in X
  $$
  其中 $ X = \{g, a, c, s, hc, hs,...\} $。

形式化表达：
$$
\mathcal{P} = \left\{ \mathbf{p}_j \in \mathcal{P}' \mid \forall x \in X,\, x_T \neq \emptyset \implies |x_j - x_T| \leq \tau_x \right\}
$$

---

#### 6. 结果输出

返回最终满足多属性与时空约束的检索结果集 $ \mathcal{P} $。

---

**补充说明：**
- 时空元信息过滤可显著提升检索效率与准确率，尤其适用于大规模多摄像头场景。
- 属性判别模型的输入为图像向量，便于与主检索流程无缝集成，后续可平滑升级为端到端图像属性识别网络。

如需进一步细化时空解析、数据库索引结构或属性判别模型实现细节，欢迎继续交流！